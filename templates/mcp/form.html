{% extends "base.html" %}

{% block title %}{{ 'Editar' if mcp_client else 'Novo' }} Servidor MCP - Fluxi.IA{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <i class="fas fa-{% if mcp_client %}edit{% else %}plus-circle{% endif %}" style="color: white; font-size: 1.5rem;"></i>
        </div>
        <div style="flex: 1; min-width: 0;">
            <h1 class="title is-3" style="margin-bottom: 0.5rem !important; line-height: 1.2; color: #1f2937;">
                {{ 'Editar' if mcp_client else 'Novo' }} Servidor MCP
            </h1>
            <p class="subtitle is-6" style="color: #6b7280; margin-bottom: 0 !important; line-height: 1.4;">
                Configure a conex√£o com o servidor MCP
            </p>
        </div>
    </div>
</div>

<form method="POST" id="mcpForm">
    
<!-- Informa√ß√µes B√°sicas -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Informa√ß√µes B√°sicas
    </h2>
    
    <div class="field">
        <label class="label">Nome do Servidor *</label>
        <div class="control">
            <input class="input" type="text" name="nome" value="{{ mcp_client.nome if mcp_client else '' }}" required placeholder="Ex: GitHub Tools, Slack MCP, Meu Sistema">
        </div>
        <p class="help">Nome para identificar este servidor MCP</p>
    </div>

    <div class="field">
        <label class="label">Descri√ß√£o</label>
        <div class="control">
            <textarea class="textarea" name="descricao" rows="2" placeholder="Descreva as funcionalidades deste servidor">{{ mcp_client.descricao if mcp_client else '' }}</textarea>
        </div>
        <p class="help">Informa√ß√µes sobre as tools dispon√≠veis neste servidor</p>
    </div>
    
    <div class="field">
        <label class="checkbox">
            <input type="checkbox" name="ativo" {% if not mcp_client or mcp_client.ativo %}checked{% endif %}>
            Servidor Ativo
        </label>
    </div>
</div>

<!-- Configura√ß√£o de Transporte -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-network-wired" style="color: #8b5cf6;"></i> Configura√ß√£o de Transporte
    </h2>
    
    <div class="field">
        <label class="label">Tipo de Transporte *</label>
        <div class="control">
            <div class="select is-fullwidth">
                <select name="transport_type" id="transport_select" onchange="updateTransportFields()" {% if mcp_client %}disabled{% endif %}>
                    <option value="stdio" {% if not mcp_client or mcp_client.transport_type.value == 'stdio' %}selected{% endif %}>STDIO - Comando Local</option>
                    <option value="streamable-http" {% if mcp_client and mcp_client.transport_type.value == 'streamable-http' %}selected{% endif %}>Streamable HTTP - Servidor Remoto</option>
                </select>
            </div>
        </div>
        <p class="help">
            <strong>STDIO:</strong> Executa comando local (Python, Node.js, etc.)<br>
            <strong>HTTP:</strong> Conecta a servidor remoto via HTTP
        </p>
    </div>
    
    <!-- Campos STDIO -->
    <div id="stdio-fields" style="{% if mcp_client and mcp_client.transport_type.value != 'stdio' %}display: none;{% endif %}">
        <div class="field">
            <label class="label">Comando *</label>
            <div class="control">
                <input class="input" type="text" name="command" id="command_input" value="{{ mcp_client.command if mcp_client else '' }}" placeholder="python, npx, uv, node, etc.">
            </div>
            <p class="help">Comando para executar o servidor MCP (ex: python, npx, uv)</p>
        </div>
        
        <div class="field">
            <label class="label">Argumentos</label>
            <div class="control">
                <input class="input" type="text" name="args" id="args_input" value="{{ mcp_client.args|join(' ') if mcp_client and mcp_client.args else '' }}" placeholder="server.py --port 8000">
            </div>
            <p class="help">Argumentos do comando (separados por espa√ßo). Ex: <code>server.py</code> ou <code>-y @modelcontextprotocol/server-github</code></p>
        </div>
        
        <div class="field">
            <label class="label">Vari√°veis de Ambiente (JSON)</label>
            <div class="control">
                <textarea class="textarea" name="env_vars" id="env_input" rows="3" placeholder='{"API_KEY": "seu_token", "GITHUB_TOKEN": "ghp_xxx"}'>{{ mcp_client.env_vars|tojson if mcp_client and mcp_client.env_vars else '' }}</textarea>
            </div>
            <p class="help">Vari√°veis de ambiente em formato JSON. Ex: <code>{"API_KEY": "valor"}</code></p>
        </div>
    </div>
    
    <!-- Campos HTTP -->
    <div id="http-fields" style="{% if not mcp_client or mcp_client.transport_type.value == 'stdio' %}display: none;{% endif %}">
        <div class="field">
            <label class="label">URL do Servidor *</label>
            <div class="control">
                <input class="input" type="url" name="url" id="url_input" value="{{ mcp_client.url if mcp_client else '' }}" placeholder="http://localhost:8000/mcp">
            </div>
            <p class="help">URL completa do servidor MCP (incluindo /mcp no final)</p>
        </div>
    </div>
</div>

<!-- Exemplos -->
<div class="box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #fbbf24; margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 700; color: #78350f; margin-bottom: 1rem;">
        <i class="fas fa-lightbulb"></i> Exemplos de Configura√ß√£o
    </h3>
    
    <div style="display: grid; gap: 1rem;">
        <div style="background: white; border-radius: 8px; padding: 1rem; border-left: 4px solid #f59e0b;">
            <strong style="color: #92400e; display: block; margin-bottom: 0.5rem;">üêç Servidor Python Local</strong>
            <code style="display: block; background: #fef3c7; padding: 0.5rem; border-radius: 4px; font-size: 0.875rem; color: #78350f;">
                Transport: STDIO<br>
                Command: python<br>
                Args: meu_servidor_mcp.py
            </code>
        </div>
        
        <div style="background: white; border-radius: 8px; padding: 1rem; border-left: 4px solid #f59e0b;">
            <strong style="color: #92400e; display: block; margin-bottom: 0.5rem;">üì¶ GitHub MCP (NPM)</strong>
            <code style="display: block; background: #fef3c7; padding: 0.5rem; border-radius: 4px; font-size: 0.875rem; color: #78350f;">
                Transport: STDIO<br>
                Command: npx<br>
                Args: -y @modelcontextprotocol/server-github<br>
                Env: {"GITHUB_TOKEN": "seu_token"}
            </code>
        </div>
        
        <div style="background: white; border-radius: 8px; padding: 1rem; border-left: 4px solid #f59e0b;">
            <strong style="color: #92400e; display: block; margin-bottom: 0.5rem;">üåê Servidor HTTP Remoto</strong>
            <code style="display: block; background: #fef3c7; padding: 0.5rem; border-radius: 4px; font-size: 0.875rem; color: #78350f;">
                Transport: Streamable HTTP<br>
                URL: https://meu-servidor.com/mcp
            </code>
        </div>
    </div>
</div>

<!-- Bot√µes -->
<div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem;">
    <button type="button" onclick="submitForm()" class="button is-medium" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; font-weight: 600; border-radius: 8px; padding: 0.75rem 2rem;">
        <span class="icon"><i class="fas fa-plug"></i></span>
        <span>{{ 'Atualizar' if mcp_client else 'Conectar Servidor' }}</span>
    </button>
    <a href="/mcp/agente/{{ agente.id }}/clients" class="button is-medium" style="border-radius: 8px; font-weight: 600; padding: 0.75rem 2rem;">
        <span class="icon"><i class="fas fa-times"></i></span>
        <span>Cancelar</span>
    </a>
</div>
</form>

<script>
function updateTransportFields() {
    const transport = document.getElementById('transport_select').value;
    const stdioFields = document.getElementById('stdio-fields');
    const httpFields = document.getElementById('http-fields');
    
    if (transport === 'stdio') {
        stdioFields.style.display = 'block';
        httpFields.style.display = 'none';
        document.getElementById('command_input').required = true;
        document.getElementById('url_input').required = false;
    } else {
        stdioFields.style.display = 'none';
        httpFields.style.display = 'block';
        document.getElementById('command_input').required = false;
        document.getElementById('url_input').required = true;
    }
}

async function submitForm() {
    const form = document.getElementById('mcpForm');
    const formData = new FormData(form);
    
    // Processar args (string para array)
    const argsStr = formData.get('args');
    let argsArray = [];
    if (argsStr && argsStr.trim()) {
        argsArray = argsStr.trim().split(/\s+/);
    }
    
    // Processar env_vars (string JSON para objeto)
    const envStr = formData.get('env_vars');
    let envObj = null;
    if (envStr && envStr.trim()) {
        try {
            envObj = JSON.parse(envStr);
        } catch (e) {
            alert('‚ùå Erro: Vari√°veis de ambiente devem estar em formato JSON v√°lido.\nEx: {"KEY": "value"}');
            return;
        }
    }
    
    // Montar payload
    const payload = {
        agente_id: {{ agente.id }},
        nome: formData.get('nome'),
        descricao: formData.get('descricao') || null,
        transport_type: formData.get('transport_type'),
        ativo: formData.get('ativo') === 'on',
        command: formData.get('command') || null,
        args: argsArray.length > 0 ? argsArray : null,
        env_vars: envObj,
        url: formData.get('url') || null
    };
    
    console.log('Enviando:', payload);
    
    try {
        const url = {% if mcp_client %}'/api/mcp/clients/{{ mcp_client.id }}'{% else %}'/api/mcp/agente/{{ agente.id }}/clients'{% endif %};
        const method = {% if mcp_client %}'PUT'{% else %}'POST'{% endif %};
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('‚úÖ Servidor MCP {{ "atualizado" if mcp_client else "criado e conectado" }} com sucesso!');
            window.location.href = '/mcp/agente/{{ agente.id }}/clients';
        } else {
            alert(`‚ùå Erro: ${data.detail || 'Erro desconhecido'}`);
        }
    } catch (error) {
        alert(`‚ùå Erro ao {{ "atualizar" if mcp_client else "criar" }}: ${error.message}`);
    }
}

// Inicializar campos corretos
document.addEventListener('DOMContentLoaded', () => {
    updateTransportFields();
});
</script>

{% endblock %}
