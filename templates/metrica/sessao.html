{% extends "base.html" %}

{% block title %}Métricas - {{ sessao.nome }} - Fluxi.IA{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 2rem;">
    <nav class="breadcrumb" aria-label="breadcrumbs" style="margin-bottom: 0.75rem !important;">
        <ul style="margin-bottom: 0 !important;">
            <li><a href="/metricas" style="color: #6b7280;"><i class="fas fa-chart-line"></i> Métricas</a></li>
            <li class="is-active"><a style="color: #C75B9B;">{{ sessao.nome }}</a></li>
        </ul>
    </nav>
    <h1 class="title is-3" style="margin-bottom: 0.75rem !important; line-height: 1.2;">
        <i class="fab fa-whatsapp" style="color: #25D366;"></i> {{ sessao.nome }}
    </h1>
    <p class="subtitle is-6" style="color: #6b7280; margin-bottom: 0 !important; line-height: 1.4;">
        Estatísticas detalhadas e performance da sessão
    </p>
</div>
    <!-- Métricas de Mensagens -->
    <div class="box">
        <h2 class="title is-4">
            <i class="fas fa-comments"></i> Mensagens
        </h2>
        
        <div class="columns is-multiline">
            <div class="column is-3">
                <div class="metric-card">
                    <div class="metric-value">{{ metricas.mensagens.total }}</div>
                    <div class="metric-label">Total</div>
                </div>
            </div>
            
            <div class="column is-3">
                <div class="metric-card">
                    <div class="metric-value" style="color: #3273dc;">{{ metricas.mensagens.recebidas }}</div>
                    <div class="metric-label">Recebidas</div>
                </div>
            </div>
            
            <div class="column is-3">
                <div class="metric-card">
                    <div class="metric-value" style="color: #48c774;">{{ metricas.mensagens.respondidas }}</div>
                    <div class="metric-label">Respondidas</div>
                </div>
            </div>
            
            <div class="column is-3">
                <div class="metric-card">
                    <div class="metric-value" style="color: #ffdd57;">{{ metricas.mensagens.com_imagem }}</div>
                    <div class="metric-label">Com Imagem</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance -->
    <div class="box">
        <h2 class="title is-4">
            <i class="fas fa-tachometer-alt"></i> Performance
        </h2>
        
        <div class="columns">
            <div class="column">
                <div class="metric-card">
                    <div class="metric-value" style="color: #48c774;">{{ metricas.performance.taxa_resposta }}%</div>
                    <div class="metric-label">Taxa de Resposta</div>
                </div>
            </div>
            
            <div class="column">
                <div class="metric-card">
                    <div class="metric-value" style="color: #3273dc;">{{ metricas.performance.tempo_medio_ms }}ms</div>
                    <div class="metric-label">Tempo Médio</div>
                </div>
            </div>
            
            <div class="column">
                <div class="metric-card">
                    <div class="metric-value" style="color: #667eea;">{{ metricas.performance.clientes_unicos }}</div>
                    <div class="metric-label">Clientes Únicos</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tokens -->
    <div class="box">
        <h2 class="title is-4">
            <i class="fas fa-coins"></i> Uso de Tokens
        </h2>
        
        <div class="columns">
            <div class="column">
                <div class="metric-card">
                    <div class="metric-value" style="color: #3273dc;">{{ metricas.tokens.input_total }}</div>
                    <div class="metric-label">Tokens Input</div>
                </div>
            </div>
            
            <div class="column">
                <div class="metric-card">
                    <div class="metric-value" style="color: #48c774;">{{ metricas.tokens.output_total }}</div>
                    <div class="metric-label">Tokens Output</div>
                </div>
            </div>
            
            <div class="column">
                <div class="metric-card">
                    <div class="metric-value" style="color: #667eea;">{{ metricas.tokens.total }}</div>
                    <div class="metric-label">Total de Tokens</div>
                </div>
            </div>
        </div>
    </div>

    <div class="columns">
        <!-- Top Clientes -->
        <div class="column is-6">
            <div class="box">
                <h2 class="title is-4">
                    <i class="fas fa-users"></i> Top 10 Clientes
                </h2>
                
                {% if top_clientes %}
                <div class="table-container">
                    <table class="table is-fullwidth is-hoverable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Telefone</th>
                                <th>Mensagens</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in top_clientes %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ cliente.telefone }}</td>
                                <td><strong>{{ cliente.total_mensagens }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="notification is-info is-light">
                    <p>Nenhum cliente ainda.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Uso de Ferramentas -->
        <div class="column is-6">
            <div class="box">
                <h2 class="title is-4">
                    <i class="fas fa-tools"></i> Uso de Ferramentas
                </h2>
                
                {% if uso_ferramentas %}
                <div class="table-container">
                    <table class="table is-fullwidth is-hoverable">
                        <thead>
                            <tr>
                                <th>Ferramenta</th>
                                <th>Usos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ferramenta in uso_ferramentas %}
                            <tr>
                                <td>{{ ferramenta.nome }}</td>
                                <td><strong>{{ ferramenta.total_usos }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="notification is-info is-light">
                    <p>Nenhuma ferramenta utilizada ainda.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

<!-- Ações -->
<div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem;">
    <a href="/sessoes/{{ sessao.id }}/detalhes" class="button is-medium" style="background: linear-gradient(135deg, #C75B9B 0%, #5B4E9B 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
        <span class="icon"><i class="fas fa-eye"></i></span>
        <span>Ver Detalhes da Sessão</span>
    </a>
    
    <a href="/mensagens/sessao/{{ sessao.id }}" class="button is-medium" style="border: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; border-radius: 8px;">
        <span class="icon"><i class="fas fa-comments"></i></span>
        <span>Ver Mensagens</span>
    </a>
    
    <a href="/metricas" class="button is-medium" style="border-radius: 8px; font-weight: 600;">
        <span class="icon"><i class="fas fa-arrow-left"></i></span>
        <span>Voltar</span>
    </a>
</div>

{% endblock %}
