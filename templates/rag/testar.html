{% extends "base.html" %}

{% block title %}Testar - {{ rag.nome }} - Fluxi.IA{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
        <a href="/rags" style="width: 48px; height: 48px; border-radius: 10px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; text-decoration: none; color: #6b7280;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div style="flex: 1; min-width: 0;">
            <h1 class="title is-3" style="margin-bottom: 0.5rem !important; line-height: 1.2; color: #1f2937;">
                <i class="fas fa-flask" style="color: #3b82f6;"></i> Testar Busca Semântica
            </h1>
            <p class="subtitle is-6" style="color: #6b7280; margin-bottom: 0 !important; line-height: 1.4;">
                Treinamento: <strong>{{ rag.nome }}</strong>
            </p>
        </div>
    </div>
</div>

{% if not rag.treinado %}
<div class="notification is-warning">
    <i class="fas fa-exclamation-triangle"></i> Este treinamento ainda não foi processado. Adicione e processe documentos antes de testar a busca.
</div>
{% endif %}

<div class="columns">
    <div class="column is-6">
        <div class="box" style="height: 100%;">
            <h2 class="title is-5" style="margin-bottom: 1.5rem;">
                <i class="fas fa-search"></i> Buscar
            </h2>
            
            <div class="field">
                <label class="label">Pergunta ou Consulta</label>
                <div class="control">
                    <textarea class="textarea" id="query" rows="4" placeholder="Digite sua pergunta aqui..." {% if not rag.treinado %}disabled{% endif %}></textarea>
                </div>
            </div>
            
            <div class="field">
                <label class="label">Número de Resultados</label>
                <div class="control">
                    <input class="input" type="number" id="top_k" value="{{ rag.top_k }}" min="1" max="20" {% if not rag.treinado %}disabled{% endif %}>
                </div>
            </div>
            
            <button onclick="buscar()" class="button is-primary is-fullwidth" {% if not rag.treinado %}disabled{% endif %}>
                <span class="icon"><i class="fas fa-search"></i></span>
                <span>Buscar</span>
            </button>
        </div>
    </div>
    
    <div class="column is-6">
        <div class="box" style="height: 100%;">
            <h2 class="title is-5" style="margin-bottom: 1.5rem;">
                <i class="fas fa-list-alt"></i> Resultados
            </h2>
            
            <div id="loading" style="display: none; text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3b82f6;"></i>
                <p style="margin-top: 1rem; color: #6b7280;">Buscando...</p>
            </div>
            
            <div id="results" style="display: none;"></div>
            
            <div id="no-results" style="text-align: center; padding: 3rem; color: #9ca3af;">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Digite uma pergunta e clique em buscar</p>
            </div>
        </div>
    </div>
</div>

<script>
async function buscar() {
    const query = document.getElementById('query').value.trim();
    const top_k = parseInt(document.getElementById('top_k').value);
    
    if (!query) {
        alert('Digite uma pergunta');
        return;
    }
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    document.getElementById('no-results').style.display = 'none';
    
    try {
        const response = await fetch('/api/rags/{{ rag.id }}/buscar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query, top_k })
        });
        
        if (!response.ok) {
            throw new Error('Erro na busca');
        }
        
        const data = await response.json();
        displayResults(data);
        
    } catch (error) {
        alert('Erro: ' + error.message);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('no-results').style.display = 'block';
    }
}

function displayResults(data) {
    document.getElementById('loading').style.display = 'none';
    
    if (!data.resultados || data.resultados.length === 0) {
        document.getElementById('no-results').innerHTML = `
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>Nenhum resultado encontrado</p>
        `;
        document.getElementById('no-results').style.display = 'block';
        return;
    }
    
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = `
        <div style="margin-bottom: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
            <strong>Query:</strong> ${data.query}<br>
            <strong>Resultados encontrados:</strong> ${data.total_resultados}
        </div>
    `;
    
    data.resultados.forEach((resultado, index) => {
        const score = resultado.metadata?.score ? (resultado.metadata.score * 100).toFixed(1) : 'N/A';
        const source = resultado.metadata?.source || 'Fonte desconhecida';
        
        resultsDiv.innerHTML += `
            <div style="margin-bottom: 1.5rem; padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <span style="background: #dbeafe; color: #1e40af; padding: 0.375rem 0.875rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600;">
                        Resultado ${index + 1}
                    </span>
                    <span style="background: #dcfce7; color: #166534; padding: 0.375rem 0.875rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600;">
                        Score: ${score}%
                    </span>
                </div>
                
                <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9375rem; line-height: 1.7; color: #1f2937;">
                    ${resultado.context}
                </div>
                
                <div style="font-size: 0.8125rem; color: #6b7280;">
                    <i class="fas fa-link"></i> <strong>Fonte:</strong> ${source}
                </div>
            </div>
        `;
    });
    
    resultsDiv.style.display = 'block';
}
</script>

{% endblock %}
